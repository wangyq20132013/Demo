var draw;var drawsource=null;var drawvector=null;var buffersource=null;var buffervector=null;var measurevector;var measureSource;var measureResult;var dragBoxSelect=null;var dragBoxSearch=null;var toolstatus='';var measureLineDraw=null;var measureAreaDraw=null;var measureStyle=new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 255, 255, 0.2)'}),stroke:new ol.style.Stroke({color:'rgba(0, 0, 0, 0.5)',lineDash:[10,10],width:2}),text:new ol.style.Text({font:'12px 微软雅黑',fill:new ol.style.Fill({color:'#fff'})})});function addMeasureSourceVector(){measureSource=new ol.source.Vector({projection:map.getView().getProjection()});measurevector=new ol.layer.Vector({name:'测绘图层',source:measureSource,style:measureStyle});map.addLayer(measurevector)}function zoomToExtent(){var _extent=mapOption.extent;map.getView().fit(new ol.geom.Polygon.fromExtent(_extent),map.getSize())}var fullScreen=function(){var elem=document.body;if(elem.webkitRequestFullScreen){elem.webkitRequestFullScreen()}else{if(elem.mozRequestFullScreen){elem.mozRequestFullScreen()}else{if(elem.msRequestFullscreen){elem.msRequestFullscreen()}else{if(elem.requestFullScreen){elem.requestFullscreen()}else{alert("浏览器不支持全屏")}}}}};var move=function(){$("#map").css('cursor','-webkit-grabbing')};var zoomin=function(){var zoom=map.getView().getZoom();zoom+=1;map.getView().setZoom(zoom);map.interaction};var zoomout=function(){var zoom=map.getView().getZoom();if(zoom-- >=0){map.getView().setZoom(zoom)}};function measureLine(){$("#map").css('cursor','pointer');if(measureSource==null&&measurevector==null){addMeasureSourceVector()}measureLineDraw=new ol.interaction.Draw({type:'LineString',source:measurevector.getSource(),style:measureStyle});map.addInteraction(measureLineDraw);var _unit=map.getView().getProjection().getUnits();measureLineDraw.on('drawstart',function(evt){if(evt.dragging){return}$("#measureResult").remove();measureSource.clear();sketch=evt.feature;var geom=evt.feature.getGeometry();$("#map").append('<div id="measureResult"></div>');measureResult=new ol.Overlay({position:geom.getCoordinates()[0],positioning:'bottom-center',element:document.getElementById('measureResult')});map.addOverlay(measureResult);geom.on('change',function(e){if(_unit=="m"){var length=geom.getLength()}else if(_unit=="degrees"){var length=0;var wgs84Sphere=new ol.Sphere(6378137);var coordinates=geom.getCoordinates();for(var i=0;i<coordinates.length-1;i+=1){var p1=coordinates[i];var p2=coordinates[i+1];length+=wgs84Sphere.haversineDistance(p1,p2)}}else{var length=geom.getLength()}if(length>1000){$("#measureResult").html((length/1000).toFixed(2)+"千米")}else if(1<length){$("#measureResult").html(length.toFixed(2)+"米")}else if(0<length){$("#measureResult").html(length.toFixed(2)*1000+"毫米")}measureResult.setPosition(geom.getLastCoordinate())})},this);measureLineDraw.on('drawend',function(evt){})}function measureArea(){$("#map").css('cursor','pointer');if(measureSource==null&&measurevector==null){addMeasureSourceVector()}measureAreaDraw=new ol.interaction.Draw({type:'Polygon',source:measurevector.getSource(),style:measureStyle});map.addInteraction(measureAreaDraw);measureAreaDraw.on('drawstart',function(evt){if(evt.dragging){return}$("#measureResult").remove();measureSource.clear();sketch=evt.feature;var geom=evt.feature.getGeometry();var _unit=map.getView().getProjection().getUnits();$("#map").append('<div id="measureResult"></div>');measureResult=new ol.Overlay({offset:[0,-15],positioning:'bottom-center',element:document.getElementById('measureResult')});map.addOverlay(measureResult);geom.on('change',function(e){if(_unit=="m"){var area=geom.getArea()}else if(_unit=="degrees"){var wgs84Sphere=new ol.Sphere(6378137);var coordinates=geom.getLinearRing(0).getCoordinates();var area=wgs84Sphere.geodesicArea(coordinates)}else{var area=geom.getArea()}if(area<10000){$("#measureResult").html(area.toFixed(2)+"平方米")}else if(area<1000000){$("#measureResult").html((area/10000).toFixed(2)+"公顷")}else{$("#measureResult").html((area/1000000).toFixed(2)+"平方公里")}measureResult.setPosition(geom.getInteriorPoint().getCoordinates())})},this)}function mapClear(){$("#map").css('cursor','pointer');$("#measureResult").remove();if(measurevector){}if(globalHeightVector){map.removeLayer(globalHeightVector)}if(measureSource){measureSource.clear()}if(buffersource){buffersource.clear()}if(drawsource){drawsource.clear()}if(measureResult){map.removeOverlay(measureResult)}if(dragBoxSelect){map.removeInteraction(dragBoxSelect)}if(dragBoxSearch){map.removeInteraction(dragBoxSearch)}if(measureLineDraw){map.removeInteraction(measureLineDraw)}if(measureAreaDraw){map.removeInteraction(measureAreaDraw)}if(draw){map.removeInteraction(draw)}}function boxSearch(options){$("#map").css('cursor','crosshair');dragBoxSearch=new ol.interaction.DragBox({});map.addInteraction(dragBoxSearch);dragBoxSearch.on('boxend',function(e){var info=[];var geom=dragBoxSearch.getGeometry();var wktFormat=new ol.format.WKT();var extentwkt=wktFormat.writeGeometry(geom);if(options&&options.callback){options.callback(e,geom,extentwkt)}else{try{addGeometry(geom);boxSearchEnd(extentwkt)}catch(e){console.log('boxSearchEnd not defined;')}}});dragBoxSearch.on('boxstart',function(){if(drawsource){drawsource.clear()}})}function polygonSearch(){$("#map").css('cursor','pointer');if(drawsource==null&&drawvector==null){addDrawSourceVector()}draw=new ol.interaction.Draw({source:drawsource,type:'Polygon'});map.addInteraction(draw);draw.on('drawstart',function(evt){if(drawsource){drawsource.clear()}if(drawvector){}});draw.on('drawend',function(evt){var feature=evt.feature;var geom=feature.getGeometry();var wktFormat=new ol.format.WKT();var polygonwkt=wktFormat.writeGeometry(geom);map.removeInteraction(draw);try{if(typeof(polygonSearchEnd)=='function'){polygonSearchEnd(polygonwkt)}}catch(e){console.log('polygonsearchEnd not defined;')}})}function pointSearch(){map.on('singleclick',function(e){var pixel=map.getEventPixel(e.originalEvent);var coordinate=map.getCoordinateFromPixel(pixel);var geom=new ol.geom.Point(coordinate);var wktFormat=new ol.format.WKT();var pointwkt=wktFormat.writeGeometry(geom);try{if(typeof(pointSearchEnd)=='function'){pointSearchEnd(pointwkt)}}catch(e){console.log('pointSearchEnd not defined;')}})}function exportMap(){map.once('postcompose',function(event){var canvas=event.context.canvas;canvas.toBlob(function(blob){saveAs(blob,'map.png')})});map.renderSync()}function addDrawSourceVector(){drawsource=new ol.source.Vector();drawvector=new ol.layer.Vector({source:drawsource,style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 0, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'#f90000',width:2}),image:new ol.style.Icon(({anchor:[0.5,1],scale:0.8,src:cxt+"/uarp/pageview/image/marker.png"}))})});map.addLayer(drawvector)}function addBufferSourceVector(){buffersource=new ol.source.Vector();buffervector=new ol.layer.Vector({source:buffersource,style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 0, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'#ffcc33',width:2})})});map.addLayer(buffervector)}function initBufferDistanceControl(){var top=$(".ol-control.ol-bar").css("top");var left=$(".ol-control.ol-bar").css("left");if(!left){left=$("#maptoolbar_bootstrap").css("left")}var bufferinput='<div id="distancecontrol" class="input-group input-group-sm" style="width:200px;position:absolute;top:45px;left:'+left+'">';bufferinput+='<span class="input-group-addon">单位：米</span>';bufferinput+='<input type="number" class="form-control" id="bufferdistance" placeholder="缓冲半径" value="1000" onblur="checkNum()">';bufferinput+='<span class="input-group-addon"><i class="fa fa-close" onclick="closeBufferDistanceControl()"></i></span>';bufferinput+='</div>';$("#map").append(bufferinput)}function initLayerSelectControl(dataset){var top=$(".ol-control.ol-bar").css("top");var left=$(".ol-control.ol-bar").css("left");if(!left){left=$("#maptoolbar_bootstrap").css("left")}var bufferinput='<div id="layerselectcontrol" class="list-group" style="width:345px;position:absolute;top:80px;left:'+left+';max-height: 247px;overflow-y: auto;">';bufferinput+='</div>';$("#map").append(bufferinput);$.ajax({type:"post",url:cxt+"/datainterface/getdata/list/"+dataset,contentType:"application/json",async:false,dataType:"JSON",success:function(data){var dataArr=data.data;var closeBtn='<i class="btn btn-primary btn-sm" title="关闭" onclick="closeLayerSelectControl(this)"><span class="fa fa-angle-double-up" aria-hidden="true"></span></i>';$("#layerselectcontrol").append(closeBtn);for(var i=0;i<dataArr.length;i+=1){var atag='<a href="#" onclick="addBufferVectorByID(\''+dataArr[i].ID+'\')" class="list-group-item">'+dataArr[i].NAME+'</a>';$("#layerselectcontrol").append(atag)}}})}function addBufferVectorByID(id){var wkt=null;$.ajax({type:"post",url:cxt+"/datainterface/getdata/list/getRiverWktByID",contentType:"application/json",async:false,dataType:"JSON",data:JSON.stringify({id:id}),success:function(data){var dataArr=data.data;wkt=dataArr[0].WKT}});if(buffersource==null&&buffervector==null){addBufferSourceVector()}else{buffersource.clear()}var bufferdistance=$('#bufferdistance').val();if(bufferdistance){var bufferwkt=createBuffer(wkt,bufferdistance);if(bufferwkt){var features=[];var wktFormat=new ol.format.WKT();var layerFeature=wktFormat.readFeature(wkt);var bufferFeature=wktFormat.readFeature(bufferwkt);bufferFeature.set("VECTORTYPE","BUFFERTOOL",true);features.push(layerFeature);features.push(bufferFeature);buffersource.addFeatures(features)}try{if(typeof(selectBufferEnd)=='function'){var extent=bufferFeature.getGeometry().getExtent();moveIn(null,null,extent,function(){setTimeout(function(){selectBufferEnd(bufferwkt)},1100)})}}catch(e){console.log('selectBufferEnd not defined;')}}else{alert("请输入缓冲半径！")}}function closeBufferDistanceControl(){var distanceinput=$('#distancecontrol');distanceinput.remove()}function closeLayerSelectControl(opt){var layerSelectList=$('#layerselectcontrol');layerSelectList.remove();$(opt).remove()}function createBuffer(wkt,distance){var _unit=map.getView().getProjection().getUnits();if(_unit=="m"){wkt=wkt}else if(_unit=="degrees"){var wktFormat=new ol.format.WKT();var geom=wktFormat.readFeature(wkt);geom.getGeometry().transform(map.getView().getProjection(),ol.proj.get("EPSG:3857"));wkt=wktFormat.writeGeometry(geom.getGeometry())}else{wkt=wkt}var bufferwkt=null;$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+'/atservices/geometry',async:false,data:{SERVICE:'buffer',geometry:wkt,distance:distance},success:function(data){if(data.success){bufferwkt=data.features[0].geometry}},error:function(){alert('getBuffer error!')}});if(_unit=="m"){bufferwkt=bufferwkt}else if(_unit=="degrees"){var wktFormat=new ol.format.WKT();var geom=wktFormat.readFeature(bufferwkt);geom.getGeometry().transform(ol.proj.get("EPSG:3857"),map.getView().getProjection());bufferwkt=wktFormat.writeGeometry(geom.getGeometry())}else{bufferwkt=bufferwkt}return bufferwkt}function pointbuffer(){if(buffersource==null&&buffervector==null){addBufferSourceVector()}var distanceinput=$('#distancecontrol');if(distanceinput.length==0){initBufferDistanceControl()}var bufferdistance=$('#bufferdistance').val();if(bufferdistance){draw=new ol.interaction.Draw({source:buffersource,type:'Point'});map.addInteraction(draw);draw.on('drawstart',function(evt){if(buffersource){buffersource.clear()}});draw.on('drawend',function(evt){var feature=evt.feature;var geom=feature.getGeometry();var wktFormat=new ol.format.WKT();var geomwkt=wktFormat.writeGeometry(geom);var bufferwkt=createBuffer(geomwkt,bufferdistance);if(bufferwkt){var features=[];var bufferFeature=wktFormat.readFeature(bufferwkt);bufferFeature.set("VECTORTYPE","BUFFERTOOL",true);features.push(bufferFeature);buffersource.addFeatures(features)}map.removeInteraction(draw);try{if(typeof(pointbufferEnd)=='function'){pointbufferEnd(bufferwkt)}}catch(e){console.log('pointSearchEnd not defined;')}})}else{alert('请输入缓存半径')}}function linebuffer(){if(buffersource==null&&buffervector==null){addBufferSourceVector()}var distanceinput=$('#distancecontrol');if(distanceinput.length==0){initBufferDistanceControl()}var bufferdistance=$('#bufferdistance').val();if(bufferdistance){draw=new ol.interaction.Draw({source:buffersource,type:'LineString'});map.addInteraction(draw);draw.on('drawstart',function(evt){if(buffersource){buffersource.clear()}});draw.on('drawend',function(evt){var feature=evt.feature;var geom=feature.getGeometry();var wktFormat=new ol.format.WKT();var geomwkt=wktFormat.writeGeometry(geom);var bufferwkt=createBuffer(geomwkt,bufferdistance);if(bufferwkt){var features=[];var bufferFeature=wktFormat.readFeature(bufferwkt);bufferFeature.set("VECTORTYPE","BUFFERTOOL",true);features.push(bufferFeature);buffersource.addFeatures(features)}map.removeInteraction(draw);try{if(typeof(linebufferEnd)=='function'){linebufferEnd(bufferwkt)}}catch(e){console.log('pointSearchEnd not defined;')}})}else{alert('请输入缓存半径')}}function polygonbuffer(){if(buffersource==null&&buffervector==null){addBufferSourceVector()}var distanceinput=$('#distancecontrol');if(distanceinput.length==0){initBufferDistanceControl()}var bufferdistance=$('#bufferdistance').val();if(bufferdistance){draw=new ol.interaction.Draw({source:buffersource,type:'Polygon'});map.addInteraction(draw);draw.on('drawstart',function(evt){if(buffersource){buffersource.clear()}});draw.on('drawend',function(evt){var feature=evt.feature;var geom=feature.getGeometry();var wktFormat=new ol.format.WKT();var geomwkt=wktFormat.writeGeometry(geom);var bufferwkt=createBuffer(geomwkt,bufferdistance);if(bufferwkt){var features=[];var bufferFeature=wktFormat.readFeature(bufferwkt);bufferFeature.set("VECTORTYPE","BUFFERTOOL",true);features.push(bufferFeature);buffersource.addFeatures(features)}map.removeInteraction(draw);try{if(typeof(polygonbufferEnd)=='function'){polygonbufferEnd(bufferwkt)}}catch(e){console.log('pointSearchEnd not defined;')}})}else{alert('请输入缓存半径')}}function selectbuffer(dataset){var distanceinput=$('#distancecontrol');if(distanceinput.length==0){initBufferDistanceControl()}var layerSelectList=$('#layerselectcontrol');if(layerSelectList.length==0){initLayerSelectControl(dataset)}}function drawpoint(callback){if(drawsource==null&&drawvector==null){addDrawSourceVector()}draw=new ol.interaction.Draw({source:drawsource,type:'Point',style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 0, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'#f90000',width:2}),image:new ol.style.Icon(({anchor:[0,1],scale:1,src:cxt+"/uarp/pageview/image/pin.png"}))})});map.addInteraction(draw);draw.on('drawstart',function(evt){if(drawsource){drawsource.clear()}});draw.on('drawend',function(evt){if(callback&&typeof callback=='function'){callback(getDrawGeometry(evt))}else{setParentGeometry(getDrawGeometry(evt))}})}function drawline(callback){if(drawsource==null&&drawvector==null){addDrawSourceVector()}draw=new ol.interaction.Draw({source:drawsource,type:'LineString',style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 0, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'#f90000',width:2}),image:new ol.style.Icon(({anchor:[0,1],scale:1,src:cxt+"/images/pin.png"}))})});map.addInteraction(draw);draw.on('drawstart',function(evt){if(drawsource){drawsource.clear()}});draw.on('drawend',function(evt){if(callback&&typeof callback=='function'){callback(getDrawGeometry(evt))}else{setParentGeometry(getDrawGeometry(evt))}})}function drawpolygon(callback){if(drawsource==null&&drawvector==null){addDrawSourceVector()}draw=new ol.interaction.Draw({source:drawsource,type:'Polygon',style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 0, 0, 0.2)'}),stroke:new ol.style.Stroke({color:'#f90000',width:2}),image:new ol.style.Icon(({anchor:[0,1],scale:1,src:cxt+"/images/pin.png"}))})});map.addInteraction(draw);draw.on('drawstart',function(evt){if(drawsource){drawsource.clear()}});draw.on('drawend',function(evt){if(callback&&typeof callback=='function'){callback(getDrawGeometry(evt))}else{setParentGeometry(getDrawGeometry(evt))}})}function getDrawGeometry(evt){var feature=evt.feature;var geom=feature.getGeometry();var wktFormat=new ol.format.WKT();var geomwkt=wktFormat.writeGeometry(geom);return geomwkt}function setParentGeometry(geomwkt){$("#"+params.dom_id,window.parent.document).val(geomwkt)}function addParentGeometry(id){var geomwkt=$("#"+id,window.parent.document).val();if(geomwkt){addGeometry(geomwkt)}else{if(drawsource){drawsource.clear()}}}function addGeometry(geometry){if(typeof geometry=='string'){geometry=new ol.format.WKT().readGeometry(geometry)}var feture=new ol.Feature({geometry:geometry});if(drawsource==null&&drawvector==null){addDrawSourceVector()}drawsource.addFeature(feture);map.getView().fit(geometry.getExtent(),map.getSize())}function checkNum(){var patrn=/^\d+(\.\d+)?$/;var bufferdistance=$('#bufferdistance').val();if((!patrn.test(bufferdistance))&&bufferdistance!=""){parent.layer.msg("缓冲半径只能为正数或零，请输入正确的数字！",{icon:3});$('#bufferdistance').val("");return[]}}