//参数加载
var mapOption=readMapOption(dataset.mapview);var mapObject={};var view=null;var map=null;var switchmapwrapper={};var layers={};$(function(){initChangeMap();map=initMap();for(var i in mapObject.mapId_Arr){}if(typeof(initBootstrapTools)=='function'){initBootstrapTools(mapOption.tools);initBootstrapExtendTools(mapOption.exttools)}else{initDefaultTools(mapOption.tools);initExtendTools(mapOption.exttools)}if(mapOption.poioption&&mapOption.pointpoi==true){addpoi(mapOption.poioption);}if(mapOption.basechange&&mapOption.basechange==true){$('.tucengkz').show()}if(mapOption.callbackPosition&&mapOption.callbackPosition["start"]==true){callbackPosition(mapOption.callbackPosition)}if(params.dom_id&&params.dom_id!=""){addParentGeometry(params.dom_id)}$(".ol-zoom").find(".ol-zoom-in")[0].title="放大";$(".ol-zoom").find(".ol-zoom-out")[0].title="缩小"});INCHES_PER_UNIT={'inches':1.0,'ft':12.0,'mi':63360.0,'m':39.3701,'km':39370.1,'dd':4374754,'yd':36};var esrijsonFormat=new ol.format.EsriJSON();var linestringVector;var linerMap={};var tableLightLayer;var chartVector;var filterVector;var projectionOption;var toolsMap={};var mainbar;var editbar;function readMapOption(mapOption){var _mapOption={};if(!mapOption.type){mapOption=mapOption[mapType];_mapOption.type=mapType;_mapOption.view={};_mapOption.view.extent=mapOption.extent;_mapOption.view.projection=mapOption.projection;_mapOption.view.resolutions=mapOption.resolutions;_mapOption.view.center=mapOption.center;_mapOption.view.zoom=mapOption.initZoom;_mapOption.view.minZoom=mapOption.minZoom;_mapOption.view.maxZoom=mapOption.maxZoom;_mapOption.view.minResolution=mapOption.minResolution;_mapOption.view.maxResolution=mapOption.maxResolution;_mapOption.view.format=mapOption.format;_mapOption.view.matrixset=mapOption.matrixset;_mapOption.maps=[];var map={};map.layertype=mapType;map.wmtsurl=mapOption.wmtsurl;map.wmsurl=mapOption.wmsurl;map.attileurl=mapOption.attileurl;map.layerurl=mapOption.layerurl;map.layernames=mapOption.layernames;map.baselayer_vector=mapOption.baselayer_vector;map.baselayer_satellite=mapOption.baselayer_satellite;map.defaultlayer=mapOption.defaultlayer;_mapOption.maps.push(map);_mapOption.tools=mapOption.tools;_mapOption.exttools=mapOption.exttools;_mapOption.popupText=mapOption.popupText;return _mapOption}else{return mapOption}if(mapOption.type=='gwc'){}else if(mapOption.type=='tianditu'){}return mapOption}function initView(){var type=mapOption.type;var viewOption=mapOption.view;var view=null;var gwc_viewOption=function(viewOption){var option={};var projectionOption=viewOption.projection;if(projectionOption.proj4){proj4.defs(projectionOption.code,projectionOption.proj4)};var projectionExtent=projectionOption.extent;option.projection=new ol.proj.Projection({"code":projectionOption.code,"units":projectionOption.units,"extent":projectionOption.extent});option.center=viewOption.center;option.zoom=viewOption.zoom;option.minResolution=viewOption.minResolution;option.maxResolution=viewOption.maxResolution;return option};var tianditu_viewOption=function(viewOption){var option={};var projectionOption=viewOption.projection?viewOption.projection:"EPSG:4326";option.projection=new ol.proj.Projection({code:"EPSG:4326",units:'degrees'});option.projection=new ol.proj.Projection({"code":projectionOption.code,"units":projectionOption.units,"extent":projectionOption.extent});option.center=viewOption.center?viewOption.center:[95,30];option.zoom=viewOption.zoom?viewOption.zoom:4;option.maxZoom=viewOption.maxZoom?viewOption.maxZoom:15;option.minZoom=viewOption.minZoom?viewOption.minZoom:2;return option};var attile_viewOption=function(viewOption){var option={};var projectionOption=viewOption.projection?viewOption.projection:"EPSG:4326";if(projectionOption.proj4){proj4.defs(projectionOption.code,projectionOption.proj4)};option.projection=new ol.proj.Projection({"code":projectionOption.code,"units":projectionOption.units,"extent":projectionOption.extent});option.center=viewOption.center?viewOption.center:[95,30];option.zoom=viewOption.zoom?viewOption.zoom:1;option.maxZoom=viewOption.maxZoom?viewOption.maxZoom:9;option.minZoom=viewOption.minZoom?viewOption.minZoom:1;return option};if(type=='gwc'){view=new ol.View(gwc_viewOption(viewOption))}else if(type=='tianditu'){view=new ol.View(tianditu_viewOption(viewOption))}else if(type=='attile'){view=new ol.View(attile_viewOption(viewOption))}mapObject.view=view;return view}function initmapContainer(number){if(number==undefined){number=1}if(number==1){var $map=$("<div id='map' class='map onemap'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});$("#mapview").find(".map").remove(".map").end().append($map);return['map']}else if(number==2){var $left_map=$("<div id='left_map' class='map left_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});var $right_map=$("<div id='right_map' class='map right_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});$("#mapview").find(".map").remove(".map").end().append($left_map).append($right_map);return['left_map','right_map']}else if(number>2&&number<=4){var $top_left_map=$("<div id='top_left_map' class='map top_left_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});var $top_right_map=$("<div id='top_right_map' class='map top_right_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});var $bottom_left_map=$("<div id='bottom_left_map' class='map bottom_left_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});var $bottom_right_map=$("<div id='bottom_right_map' class='map bottom_right_map'></div>").css({"background-color":"rgb(218, 245, 253)","background-image":"url('"+cxt+"/uarp/pageview/image/blankimg_zh.png')"});$("#mapview").find(".map").remove(".map").end().append($top_left_map).append($top_right_map).append($bottom_left_map).append($bottom_right_map);return['top_left_map','top_right_map','bottom_left_map','bottom_right_map']}else{console.error('不支持的地图容器数量！！！！');return false}return['map']}function initMap(mapId){view=initView();var _map=null;if(mapOption.maps){_map={};var maps=mapOption.maps;var mapId_Arr=null;if(mapId){mapId_Arr=[mapId]}else{mapId_Arr=initmapContainer(mapOption.mapNumber)}mapObject.mapId_Arr=mapId_Arr;for(var i=0;i<mapId_Arr.length;i+=1){var map=new ol.Map({target:mapId_Arr[i],controls:ol.control.defaults({attribution:false}),layers:[],view:view});var scaleLineControl=new ol.control.ScaleLine({});scaleLineControl.setUnits('metric');map.addControl(scaleLineControl);var layertype=maps[i].layertype;if(!layertype){continue}var layerUrl=maps[i].layerurl;var wmsurl=maps[i].wmsurl;if(layerUrl==undefined){layerUrl=mapOption.layerurl}else if(layerUrl&&layerUrl.indexOf("http://")==-1){try{layerUrl=attilesurl+layerUrl}catch(e){layerUrl=cxt+layerUrl}}var layernames=maps[i].layernames;var baselayer_vector=maps[i].baselayer_vector;var baselayer_satellite=maps[i].baselayer_satellite;var defaultlayer=maps[i].defaultlayer;var originFlag=maps[i].originFlag;for(var j=0;j<layernames.length;j+=1){var map_layer=layers[layernames[j]];if(!map_layer){if(layertype=="wmts"){map_layer=getWmtsLayer(layerUrl,layernames[j],originFlag)}else if(layertype=="tianditu"){map_layer=getXYZImageLayer(layerUrl,layernames[j],originFlag)}else if(layertype=="attile"){map_layer=getXYZImageLayer(layerUrl,layernames[j],originFlag)}else if(layertype=="wms"){map_layer=getWmsLayer(layerUrl,layernames[j],originFlag)}layers[layernames[j]]=map_layer}if(layernames[j]==baselayer_vector){switchmapwrapper["baselayer_vector"]=map_layer}else if(layernames[j]==baselayer_satellite){switchmapwrapper["baselayer_satellite"]=map_layer}map.addLayer(map_layer)}switchMap(defaultlayer);_map[mapId_Arr[i]]=map}if(maps.length>mapId_Arr.length){for(var i=0;i<mapObject.mapId_Arr.length;i+=1){createSwitchLayerPanel(mapObject.mapId_Arr[i],maps,'base')}}}return(Object.getOwnPropertyNames(_map).length==1?_map[Object.getOwnPropertyNames(_map)[0]]:_map)}function getWmsLayer(wmsUrl,wmsLayer,params){var wmsLayer=new ol.layer.Tile({name:wmsLayer,source:new ol.source.TileWMS({ratio:1,url:wmsUrl,params:$.extend({'FORMAT':"image/png",'VESION':'1.1.1','STYLE':'default','LAYERS':wmsLayer},params)})});return wmsLayer}function getWmtsLayer(wmtsUrl,wmtsLayer,params){var matrixSet=mapOption.view.matrixset;var projection=view.getProjection();var resolutions=mapOption.view.resolutions;var format=mapOption.view.format;var extent=mapOption.view.extent;var style=mapOption.view.style;var matrixIds=[];for(var i=0;i<resolutions.length;i+=1){matrixIds.push(matrixSet+":"+i)}var wmtsSource=new ol.source.WMTS({url:wmtsUrl,layer:wmtsLayer,matrixSet:matrixSet,format:format,projection:projection,tileGrid:new ol.tilegrid.WMTS({origin:ol.extent.getTopLeft(extent),resolutions:resolutions,matrixIds:matrixIds}),style:style,wrapX:true});var wmtsLayer=new ol.layer.Tile({name:wmtsLayer,opacity:1,source:wmtsSource});return wmtsLayer}function getXYZImageLayer(url,layername,originFlag){url=url.replace('{layername}',layername);var projection=view.getProjection();var tilelayer=new ol.layer.Tile({name:layername,source:new ol.source.TileImage({maxZoom:9,projection:projection,tileSize:256,tileUrlFunction:function(tileCoord){return url.replace('{z}',(tileCoord[0]+1).toString()).replace('{x}',tileCoord[1].toString()).replace('{y}',(Math.pow(2,tileCoord[0])+tileCoord[2]).toString())}})});return tilelayer}function initChangeMap(){$("#SwitchMapOnOff").click(function(){var status=$(this).attr("src");var url=status;if(status.indexOf("switchmapon.png")!=-1){url=url.replace("switchmapon.png","switchmapoff.png");$("#switchmapwrapper").show("slow")}else{url=url.replace("switchmapoff.png","switchmapon.png");$("#switchmapwrapper").hide("slow")}$(this).attr("src",url)});$("#switchmapwrapper").find("li").click(function(){if(!$(this).find("img").hasClass("active")){$("#switchmapwrapper").find("img").removeClass("active");$(this).find("img").addClass("active");var datatype=$(this).attr("datatype");switchMap(datatype)}$("#SwitchMapOnOff").click()});$("li[datatype="+mapOption.defaultlayer+"]").find("img").addClass("active")}function switchMap(datatype){for(var i in switchmapwrapper){if(i==datatype){switchmapwrapper[i].setVisible(true)}else{switchmapwrapper[i].setVisible(false)}}}function createSwitchLayerPanel(mapId,data,title){var num=(Math.random()*100).toFixed(0);var $panel=$("#"+mapId).find(".switchLayer-panel");var $panel_body=null;if($panel.length==0){$panel=$("<div class='popover right tabpanel switchLayer-panel'></div>");$panel_body=$("<div id='"+title+num+"' title='"+title+"' class='panel-body'></div>");$panel.append($panel_body)}else{var $tab_list=$panel.find(".nav-tabs");var $tab_content=$panel.find(".tab-content");title=(title==undefined?'对比':title);if($tab_list.length==0){$panel_body=$panel.find(".panel-body");var $tab_list=$("<ul class='nav nav-tabs'></ul>");var $tab_content=$("<div class='tab-content'></div>");$tab_list.append("<li class='active'><a href='#"+$panel_body.attr("id")+"' aria-controls='"+$panel_body.attr("id")+"' data-toggle='tab'>"+$panel_body.attr("title")+"</a></li>");$tab_list.append("<li><a href='#"+title+num+"' aria-controls='"+title+num+"' data-toggle='tab'>"+title+"</a></li>");$panel_body.addClass("tab-pane active");$tab_content.append($panel_body);$panel_body=$("<div id='"+title+num+"' class='panel-body tab-pane'></div>");$tab_content.append($panel_body);$panel.append($tab_list).append($tab_content)}else{$tab_list.append("<li><a href='#"+title+num+"' aria-controls='"+title+num+"' data-toggle='tab'>"+title+"</a></li>");$panel_body=$("<div id='"+title+num+"' class='panel-body tab-pane'></div>");$tab_content.append($panel_body)}}$.each(data,function(i,item){var $input=$("<input type='checkbox' class='"+(item.title?item.title:item.TITLE)+"' />").data("data",item);$input.on("click",function(){var data=$(this).data("data");data.checked=$(this).is(":checked");var mapId=$($(this).parentsUntil(".map").parent()[0]).attr("id");if(data.checked==true){$("."+$(this).attr("class")).attr("disabled",true);$(this).parent().parent().parent().find("input[type='checkbox']").attr("disabled",true);$(this).attr("disabled",false)}else{$(this).parentsUntil(".panel-body").parent().find("input[type='checkbox']").attr("disabled",false);$("."+$(this).attr("class")).attr("disabled",false)}switchLayer(map[mapId],data)});var $item=$("<div class='checkbox'><label></label></div>");$item.find("label").append($input).append((item.title?item.title:item.TITLE));$panel_body.append($item)});$("#"+mapId).append($panel);return $panel_body}function switchLayer(map,data){var layername=data.layername;var layerurl=data.layerurl;var layertype=data.layertype;if(data.checked==true){if(layerurl.indexOf("http://")==-1){layerurl=gwcwmtsurl+layerurl}var layer=getWmtsLayer(layerurl,data.name);map.addLayer(layer);layers[layername]=layer}else{map.removeLayer(layers[layername])}}function initDefaultTools(tools){if(tools==undefined){return}editbar=new ol.control.Bar({toggleOne:true,group:false});if(mapOption.tools["mainbar"]==true){mainbar=new ol.control.Bar();map.addControl(mainbar);mainbar.addControl(editbar)}var bounds=projectionOption.extent;map_tools_fullScreen=new ol.control.FullScreen({html:'<i class="fa fa-tv"></i>',tipLabel:"全屏"});toolsMap['fullscreen']=map_tools_fullScreen;map_tools_globe=new ol.control.ZoomToExtent({tipLabel:"全图",className:'ol-zoom-extent',extent:bounds});toolsMap['globe']=map_tools_globe;map_tools_move=new ol.control.Button({html:'<i class="fa fa-arrows"></i>',title:"平移",handleClick:function(){mapClear();$("#map").css('cursor','-webkit-grab')}});toolsMap['move']=map_tools_move;map_tools_measureline=new ol.control.Button({html:'<i class="fa fa-magic"></i>',title:"测距",handleClick:function(){measureLine()}});toolsMap['measureline']=map_tools_measureline;map_tools_measurearea=new ol.control.Button({html:'<i class="fa fa-bookmark-o fa-rotate-270"></i>',title:"测面",handleClick:function(){measureArea()}});toolsMap['measurearea']=map_tools_measurearea;map_tools_pointsearch=new ol.control.Button({html:'<i class="fa fa-hand-pointer-o"></i>',title:"点查询",handleClick:function(){$("#map").css('cursor','default');pointSearch()}});toolsMap['pointsearch']=map_tools_pointsearch;map_tools_boxsearch=new ol.control.Button({html:'<i class="fa fa-square-o"></i>',title:"拉框查询",handleClick:function(){$("#map").css('cursor','default');boxSearch()}});toolsMap['boxsearch']=map_tools_boxsearch;map_tools_polygonsearch=new ol.control.Button({html:'<i class="fa fa-bookmark-o fa-rotate-180"></i>',title:"多边形查询",handleClick:function(){polygonSearch()}});toolsMap['polygonsearch']=map_tools_polygonsearch;map_tools_clear=new ol.control.Button({name:'clear',html:'<i class="fa fa-trash"></i>',title:'清除',handleClick:function(){$("#map").css('cursor','default');mapClear()}});toolsMap['clear']=map_tools_clear;map_tools_exportmap=new ol.control.Button({html:'<i class="fa fa-download"></i>',title:"导出",handleClick:function(){exportMap()}});toolsMap['export']=map_tools_exportmap;for(var key in tools){if(tools[key]==true&&key!="mainbar"){editbar.addControl(toolsMap[key])}}}function initExtendTools(exttools){if(toolbar==undefined){return}for(var i=0;i<toolbar.length;i+=1){var click=toolbar[i].click;toolsMap[toolbar[i].name]=new ol.control.Button({name:toolbar[i].name,html:'<i class="'+toolbar[i].icon+'"></i>',title:toolbar[i].title,clickEvent:toolbar[i].click,handleClick:function(e,options){if(options.clickEvent&&options.clickEvent!=''){eval(options.clickEvent)}}});editbar.addControl(toolsMap[toolbar[i].name])}}function pointPoi(dataset){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,success:function(data){for(var i=0;i<data.data.length;i+=1){var _src=cxt+"/resources/commons/ext/images/poi.png";var coord=[data.data[i].X,data.data[i].Y];var iconFeature=new ol.Feature({geometry:new ol.geom.Point(coord),name:'POI Test',type:'pois',population:4000,rainfall:500,params:data.data});var iconStyle=new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,1],src:_src}))});iconStyle.getImage().setScale(1);iconFeature.setStyle(iconStyle);var vectorSource=new ol.source.Vector({features:[iconFeature]});var vectorLayer=new ol.layer.Vector({source:vectorSource});map.addLayer(vectorLayer);vectorLayer.setZIndex(40)}}})}function lineString(option){var dataset=option.dataset;var rows=option.params["rows"];for(var i=0;i<rows.length;i+=1){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,data:JSON.stringify(rows[i]),success:function(data){var lightWkt=[];var lightMap={};for(var i=0;i<data.data.length;i+=1){if(i==0){lightMap[data.data[i].NAME]=[];lightMap[data.data[i].NAME].push([data.data[i].X,data.data[i].Y])}else{if(data.data[i-1].NAME==data.data[i].NAME){lightMap[data.data[i-1].NAME].push([data.data[i].X,data.data[i].Y])}else{lightMap[data.data[i].NAME]=[];lightMap[data.data[i].NAME].push([data.data[i].X,data.data[i].Y])}}}for(var key in lightMap){var wkt="LINESTRING(";for(var j=0;j<lightMap[key].length;j+=1){wkt+=lightMap[key][j][0]+' '+lightMap[key][j][1]+','}wkt=wkt.substr(0,wkt.length-1);wkt+=')';lightWkt.push(wkt);linerMap[key]=wkt}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}linestringVector=new ol.layer.Vector({name:"轨迹图层",source:new ol.source.Vector({features:features}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:'#0bb7f9',width:3,})})});map.addLayer(linestringVector)}})}}function lightMapLayer(row){if(tableLightLayer){map.removeLayer(tableLightLayer)}var lightWkt=[linerMap[row.NAME]];var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}tableLightLayer=new ol.layer.Vector({name:"高亮图层",source:new ol.source.Vector({features:features}),style:new ol.style.Style({fill:new ol.style.Fill({color:'#333'}),stroke:new ol.style.Stroke({color:'#333',width:3,lineDash:[10,10]}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#333'})})})});map.addLayer(tableLightLayer);map.getView().setCenter(ol.extent.getCenter(feature.getGeometry().getExtent()));map.getView().setZoom(22)}var poiVector;function addpoi(option){var dataset=option.dataset;if(option.clear==true){if(poiVector){map.removeLayer(poiVector)}}var theGlyph="";function setFont(g){if(typeof(g)=='string'){theGlyph=g}else{theGlyph=$(this).data("glyph")}vector.changed()}var glyph=ol.style.FontSymbol.prototype.defs.glyphs;function getFeatureStyle(feature){var st=[];if(mapOption.poishadow&&mapOption.poishadow==true){st.push(new ol.style.Style({image:new ol.style.Shadow({radius:15,blur:5,offsetX:0,offsetY:0,fill:new ol.style.Fill({color:"rgba(0,0,0,0.5)"})})}))}st.push(new ol.style.Style({image:new ol.style.FontSymbol({form:option.poiform?option.poiform:"none",gradient:option.poigradient?option.poigradient:"false",glyph:theGlyph,fontSize:Number(option.poifontsize?option.poifontsize:"1"),radius:Number(option.poiradius?option.poiradius:"15"),rotation:Number(option.poirotation?option.poirotation:"15")*Math.PI/180,rotateWithView:$("#rwview").prop('checked'),offsetY:$("#offset").prop('checked')? -Number($("#radius").val()):0,color:option.poicolor?option.poicolor:"",fill:new ol.style.Fill({color:option.poifillcolor?option.poifillcolor:"navy"}),stroke:new ol.style.Stroke({color:option.poistrokecolor?option.poistrokecolor:"white",width:Number(option.poiborder?option.poiborder:"3")})}),stroke:new ol.style.Stroke({width:2,color:'#f80'}),fill:new ol.style.Fill({color:[255,136,0,0.6]})}));return st}function getStyle(feature,resolution){var s=getFeatureStyle(feature);return s};var lightWkt=[];if(dataset&&dataset!=""){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,data:JSON.stringify(option.params),success:function(data){for(var i=0;i<data.data.length;i+=1){lightWkt.push('POINT('+data.data[i].X+' '+data.data[i].Y+')')}}})}else if(cbkPositionMap){lightWkt.push('POINT('+cbkPositionMap["x"]+' '+cbkPositionMap["y"]+')')}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}poiVector=new ol.layer.Vector({name:'1914-18',source:new ol.source.Vector({features:features}),renderOrder:ol.ordering.yOrdering(),style:getStyle});map.addLayer(poiVector);setFont(option.poifont?option.poifont:"fa-pied-piper-alt");vector.changed()}var popup=null;var popupVector=null;var popupSelect=null;function popupAnim(row){if(popupVector){map.removeLayer(popupVector)}if(popup){map.removeOverlay(popup)}if(popupSelect){map.removeInteraction(popupSelect)}popup=new ol.Overlay.Popup({popupClass:"black",closeBox:true,onclose:function(){map.removeInteraction(popupSelect);map.removeLayer(popupVector)},positioning:'bottom-center',autoPan:true,autoPanAnimation:{duration:100}});map.addOverlay(popup);var wkts=['POINT('+row.X+' '+row.Y+')'];var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<wkts.length;i+=1){var feature=wktformat.readFeature(wkts[i]);features.push(feature)}popupVector=new ol.layer.Vector({source:new ol.source.Vector({features:features}),style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(204, 204, 204, 1)'}),stroke:new ol.style.Stroke({color:'rgba(204, 204, 204, 1)',width:3}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:'rgba(204, 204, 204, 1)'})})})});map.addLayer(popupVector);map.getView().setCenter(ol.extent.getCenter(features[0].getGeometry().getExtent()));popupSelect=new ol.interaction.Select({style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(204, 204, 204, 0)'}),stroke:new ol.style.Stroke({color:'rgba(204, 204, 204, 0)',width:0}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'rgba(204, 204, 204, 0)'})})})});map.addInteraction(popupSelect);var dataset=mapOption.popupoption["dataset"];var popParams=mapOption.popupoption["params"];var metadata=listOption["metadata"];var labelTextMap={};for(var i=0;i<metadata.length;i+=1){if(metadata[i].checkbox!=true){labelTextMap[metadata[i].field]=metadata[i].title}}var content="<div class='ol-popup-content' style='padding: 10px;height:250px;overflow-y:auto;min-width:210px;'><p>";for(var key in labelTextMap){if(row[key]&&row[key]!="null"){content+='<label for="con">'+labelTextMap[key]+'：</label><span>'+row[key]+'</span><br/>'}else{content+='<label for="con">'+labelTextMap[key]+'：</label><span>未知</span><br/>'}}content+='</p></div>';popup.show([row.X,row.Y],content);$('.closeBox.hasclosebox').css('margin','5px 20px -11px -30px');$('.closeBox.hasclosebox').next().css('margin-right','0');popupSelect.getFeatures().on(['remove'],function(e){popup.hide()})}var cbkPositionMap={};var beforePositionVector,afterPositionVector;function callbackPosition(option){map.on('click',function(){var position=$('.ol-mouse-position').text().split(",");cbkPositionMap={"x":Number(position[0]),"y":Number(position[1])};if(option.clear==true){if(afterPositionVector){map.removeLayer(afterPositionVector)}}var dataset=option.dataset;var theGlyph="";function setFont(g){if(typeof(g)=='string'){theGlyph=g}else{theGlyph=$(this).data("glyph")}vector.changed()}var glyph=ol.style.FontSymbol.prototype.defs.glyphs;function getFeatureStyle(feature){var st=[];if(mapOption.poishadow&&mapOption.poishadow==true){st.push(new ol.style.Style({image:new ol.style.Shadow({radius:15,blur:5,offsetX:0,offsetY:0,fill:new ol.style.Fill({color:"rgba(0,0,0,0.5)"})})}))}st.push(new ol.style.Style({image:new ol.style.FontSymbol({form:option.poiform?option.poiform:"none",gradient:option.poigradient?option.poigradient:"false",glyph:theGlyph,fontSize:Number(option.poifontsize?option.poifontsize:"1"),radius:Number(option.poiradius?option.poiradius:"15"),rotation:Number(option.poirotation?option.poirotation:"15")*Math.PI/180,rotateWithView:$("#rwview").prop('checked'),offsetY:$("#offset").prop('checked')? -Number($("#radius").val()):0,color:option.poicolor?option.poicolor:"",fill:new ol.style.Fill({color:option.poifillcolor?option.poifillcolor:"navy"}),stroke:new ol.style.Stroke({color:option.poistrokecolor?option.poistrokecolor:"white",width:Number(option.poiborder?option.poiborder:"3")})}),stroke:new ol.style.Stroke({width:2,color:'#f80'}),fill:new ol.style.Fill({color:[255,136,0,0.6]})}));return st}function getStyle(feature,resolution){var s=getFeatureStyle(feature);return s};var lightWkt=[];if(dataset&&dataset!=""){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,success:function(data){for(var i=0;i<data.data.length;i+=1){lightWkt.push('POINT('+data.data[i].X+' '+data.data[i].Y+')')}}})}else if(cbkPositionMap){lightWkt.push('POINT('+cbkPositionMap["x"]+' '+cbkPositionMap["y"]+')')}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}afterPositionVector=new ol.layer.Vector({name:'1914-18',source:new ol.source.Vector({features:features}),renderOrder:ol.ordering.yOrdering(),style:getStyle});map.addLayer(afterPositionVector);setFont(option.poifont?option.poifont:"fa-pied-piper-alt");vector.changed();switch(option.callback){case "queryXZQHByXY":queryXZQHByXY(cbkPositionMap["x"],cbkPositionMap["y"]);break;case "saveposition":saveposition(cbkPositionMap["x"],cbkPositionMap["y"]);break;default:break}})}function clearPoi(){var mappArr=[];mapArr=map.getLayers().array_;for(var i=0;i<mapArr.length;i+=1){if(mapArr[i].values_.name!='天地图'&&mapArr[i].values_.name!='测绘图层'&&mapArr[i].values_.name!='单选高亮图层'){map.removeLayer(mapArr[i])}}map.renderSync()}