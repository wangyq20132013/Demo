//参数加载
var mapOption=dataset.mapview["tianditu"];var map=null;var tileUrl=cxt+"/tileServerProxy";if(sispcxt){tileUrl=sispcxt+"/tileServerProxy"}var format='image/png';var layers={};INCHES_PER_UNIT={'inches':1.0,'ft':12.0,'mi':63360.0,'m':39.3701,'km':39370.1,'dd':4374754,'yd':36};var mapParams={"center":mapOption.center?mapOption.center:[95,30],"maxExtent":mapOption.maxextent?mapOption.maxextent:[-180,-90,180,90],"maxViewExtent":mapOption.maxviewextent?mapOption.maxviewextent:[-120,-60,120,60],"bestExtent":[114,34,123,38],"projection":mapOption.projection?mapOption.projection:"EPSG:4326","initZoom":mapOption.initzoom?mapOption.initzoom:4,"maxZoom":mapOption.maxzoom?mapOption.maxzoom:15,"minZoom":mapOption.minzoom?mapOption.minzoom:2,"tileSize":256,"tilenum":16,"visible":false,"extent":mapOption.extent?mapOption.extent:[-180,-90,180,90]};var layerConfig={"baselayer_vector":[addXYZImageLayer(tileUrl+"?T=vec_c&l={l}&x={x}&y={y}",mapParams),addXYZImageLayer(tileUrl+"?T=cva_c&l={l}&x={x}&y={y}",mapParams)],"baselayer_satellite":[addXYZImageLayer(tileUrl+"?T=img_c&l={l}&x={x}&y={y}",mapParams),addXYZImageLayer(tileUrl+"?T=cia_c&l={l}&x={x}&y={y}",mapParams)],"baselayer_terrain":[addXYZImageLayer(tileUrl+"?T=ter_c&l={l}&x={x}&y={y}",mapParams),addXYZImageLayer(tileUrl+"?T=cta_c&l={l}&x={x}&y={y}",mapParams)]};var lastLayer=[];var defaultLayer=mapOption.defaultlayer?layerConfig[mapOption.defaultlayer]:layerConfig["baselayer_vector"];for(var i=0;i<defaultLayer.length;i+=1){defaultLayer[i].setVisible(true);lastLayer.push(defaultLayer[i])}var esrijsonFormat=new ol.format.EsriJSON();var linestringVector;var linerMap={};var tableLightLayer;var chartVector;var filterVector;$(function(){initChangeMap();initMap();if(typeof(initBootstrapTools)=='function'){initBootstrapTools(mapOption.tools);initBootstrapExtendTools(mapOption.exttools)}else{initDefaultTools(mapOption.tools);initExtendTools(mapOption.exttools)}if(mapOption.poioption&&mapOption.pointpoi==true){addpoi(mapOption.poioption);}if(mapOption.basechange&&mapOption.basechange==true){$('.tucengkz').show()}if(mapOption.callbackPosition&&mapOption.callbackPosition["start"]==true){callbackPosition(mapOption.callbackPosition)}if(params.dom_id&&params.dom_id!=""){addParentGeometry(params.dom_id)}$(".ol-zoom").find(".ol-zoom-in")[0].title="放大";$(".ol-zoom").find(".ol-zoom-out")[0].title="缩小"});function initChangeMap(){$("#SwitchMapOnOff").click(function(){var status=$(this).attr("src");var url=status;if(status.indexOf("switchmapon.png")!=-1){url=url.replace("switchmapon.png","switchmapoff.png");$("#switchmapwrapper").show("slow")}else{url=url.replace("switchmapoff.png","switchmapon.png");$("#switchmapwrapper").hide("slow")}$(this).attr("src",url)});$("#switchmapwrapper").find("li").click(function(){if(!$(this).find("img").hasClass("active")){$("#switchmapwrapper").find("img").removeClass("active");$(this).find("img").addClass("active");var datatype=$(this).attr("datatype");switchMap(datatype)}$("#SwitchMapOnOff").click()})}function switchMap(datatype){for(var i in lastLayer){lastLayer[i].setVisible(false)}lastLayer.length=0;var tmpLayer=layerConfig[datatype];for(var i in tmpLayer){tmpLayer[i].setVisible(true);lastLayer.push(tmpLayer[i])}}function initMap(){var projection=new ol.proj.Projection({code:mapParams["projection"],units:mapOption.units?mapOption.units:'degrees'});var view=new ol.View({projection:projection,center:mapParams["center"],zoom:mapParams["initZoom"],maxZoom:mapParams["maxZoom"],minZoom:mapParams["minZoom"]});map=new ol.Map({controls:ol.control.defaults({attribution:false}),target:'map',layers:[],view:view});for(var i in layerConfig){map.addLayer(layerConfig[i][0]);map.addLayer(layerConfig[i][1])}}function addXYZImageLayer(url,mapParams){var projection=ol.proj.get(mapParams.projection);var projectionExtent=mapParams.maxExtent?mapParams.maxExtent:projection.getExtent();var maxResolution=mapParams.maxResolution?mapParams.maxResolution:(ol.extent.getWidth(projectionExtent)/(mapParams.tileSize*2));var resolutions=[mapParams.tilenum];var z;for(z=0;z<mapParams.tilenum;z+=1){resolutions[z]=maxResolution/Math.pow(2,z)}var tileOrigin=ol.extent.getTopLeft(projectionExtent);var originFlag=mapParams["originFlag"];if(originFlag){if(originFlag=="bottomleft"){tileOrigin=ol.extent.getBottomLeft(projectionExtent)}else if(originFlag=="bottomright"){tileOrigin=ol.extent.getBottomRight(projectionExtent)}else if(originFlag=="topright"){tileOrigin=ol.extent.getTopRight(projectionExtent)}}var layer=new ol.layer.Tile({visible:mapParams.visible,extent:mapParams.maxExtent,name:"天地图",source:new ol.source.TileImage({tileUrlFunction:function(tileCoord,pixelRatio,projection){var l=tileCoord[0]+1;var x=tileCoord[1];var y= -tileCoord[2]-1;if(originFlag&&originFlag=="bottomleft"){y=tileCoord[2]}var n=Math.pow(2,z+1);x=x%n;if(x*n<0){x=x+n}return url.replace('{l}',l.toString()).replace('{y}',y.toString()).replace('{x}',x.toString())},projection:projection,tileGrid:new ol.tilegrid.TileGrid({origin:tileOrigin,resolutions:resolutions,tileSize:mapParams.tileSize})})});return layer}var map_tools_olchart,map_tools_choose,map_tools_point,map_tools_ledit,map_tools_pedit,map_tools_share,map_tools_globe,map_tools_clear,map_tools_save,map_tools_mapo,map_tools_pointsearch;var toolsMap={};var mainbar;function initTools(){measureSource=new ol.source.Vector({});vector=new ol.layer.Vector({name:'测绘图层',source:measureSource,style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(238, 238, 238, 0.36)'}),stroke:new ol.style.Stroke({color:'#646464',width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#ffcc33'})})})});map.addLayer(vector);map_tools_share=new ol.control.Permalink({title:"养护助手",onclick:function(url){$('#modal .modal-body').html('<img src="http://172.172.3.108:8080/uadp/qrcodecnt/checkassistant" />');$('#modal .modal-title').html('养护助手');$('#modal .modal-body').css('text-align','center');$('#modal').modal('show')}});toolsMap['share']=map_tools_share;map_tools_globe=new ol.control.ZoomToExtent({label:$('.fa-globe')[0],tipLabel:"全图",extent:[115.05716,39.18131,117.79651,41.21872]});toolsMap['globe']=map_tools_globe;var canvasScaleline=new ol.control.CanvasScaleLine();map.addControl(new ol.control.CanvasScaleLine({style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(238, 238, 238, 0.36)'}),stroke:new ol.style.Stroke({color:'#646464',width:2}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#ffcc33'})})})}));var editbar=new ol.control.Bar({toggleOne:true,group:false});if(mapOption.tools["mainbar"]==true){mainbar=new ol.control.Bar();map.addControl(mainbar);mainbar.addControl(editbar)}var sbar=new ol.control.Bar();sbar.addControl(new ol.control.TextButton({html:'<i class="fa fa-times"></i>',title:"删除",handleClick:function(){var features=selectCtrl.getInteraction().getFeatures();if(!features.getLength()){console.log("Select an object first...")}else{console.log(features.getLength()+" object(s) deleted.")}for(var i=0,f;f=features.item(i);i+=1){vector.getSource().removeFeature(f)}selectCtrl.getInteraction().getFeatures().clear()}}));sbar.addControl(new ol.control.TextButton({html:'<i class="fa fa-info"></i>',title:"信息展示",handleClick:function(){switch(selectCtrl.getInteraction().getFeatures().getLength()){case 0:console.log("必须先选择一个...");break;case 1:var f=selectCtrl.getInteraction().getFeatures().item(0);console.log("Selection is a "+f.getGeometry().getType());console.log("Selection's geometry is "+f.getGeometry());console.log("Selection's extent is "+f.getGeometry().getExtent());break;default:console.log(selectCtrl.getInteraction().getFeatures().getLength()+" objects seleted.");break}}}));map_tools_choose=new ol.control.Toggle({html:'<i class="fa fa-hand-pointer-o"></i>',title:"选择",interaction:new ol.interaction.Select(),bar:sbar,active:false});toolsMap['choose']=map_tools_choose;map_tools_point=new ol.control.Toggle({html:'<i class="fa fa-map-marker" ></i>',title:'绘点',interaction:new ol.interaction.Draw({type:'Point',source:vector.getSource()})});toolsMap['point']=map_tools_point;var drawStyle=new ol.style.Style({fill:new ol.style.Fill({color:'rgba(255, 255, 255, 0.2)'}),stroke:new ol.style.Stroke({color:'rgba(0, 0, 0, 0.5)',lineDash:[10,10],width:2}),image:new ol.style.Circle({radius:5,stroke:new ol.style.Stroke({color:'rgba(0, 0, 0, 0.7)'}),fill:new ol.style.Fill({color:'rgba(255, 255, 255, 0.2)'})})});var lineDraw=new ol.interaction.Draw({type:'LineString',source:vector.getSource(),style:drawStyle});lineDraw.on('drawstart',function(evt){$("#measureResult").remove();measureSource.clear();sketch=evt.feature;var geom=evt.feature.getGeometry();$("#mapview").append('<div id="measureResult"></div>');measureResult=new ol.Overlay({position:geom.getCoordinates()[0],positioning:'bottom-center',element:document.getElementById('measureResult')});map.addOverlay(measureResult);geom.on('change',function(e){console.log(e);var inPerDisplayUnit=INCHES_PER_UNIT['m'];var length=geom.getLength();if(inPerDisplayUnit){var inPerMapUnit=INCHES_PER_UNIT['dd'];length*=(inPerMapUnit/inPerDisplayUnit)}if(length>1000){$("#measureResult").html((length/1000).toFixed(2)+"千米")}else if(1<length){$("#measureResult").html(length.toFixed(2)+"米")}else if(0<length){$("#measureResult").html(length.toFixed(2)*1000+"毫米")}measureResult.setPosition(geom.getLastCoordinate())})},this);map_tools_ledit=new ol.control.Toggle({html:'<i class="fa fa-magic" ></i>',title:'测距',interaction:lineDraw,bar:new ol.control.Bar({controls:[new ol.control.TextButton({html:'undo',title:"Delete last point",handleClick:function(){if(ledit.getInteraction().sketchCoords_.length<=2){$("#measureResult").html('')}ledit.getInteraction().removeLastPoint()}}),new ol.control.TextButton({html:'Finish',title:"finish",handleClick:function(){var drawi=ledit.getInteraction();var lkey=drawi.on('drawend',function(e){drawi.unByKey(lkey);var c=e.feature.getGeometry().getCoordinates();if(c.length<2){throw "Bad LineString"}});try{drawi.finishDrawing()}catch(e){drawi.unByKey(lkey)}}})]})});toolsMap['ledit']=map_tools_ledit;var polygonDraw=new ol.interaction.Draw({type:'Polygon',source:vector.getSource(),style:drawStyle});polygonDraw.on('drawstart',function(evt){$("#measureResult").remove();measureSource.clear();sketch=evt.feature;var geom=evt.feature.getGeometry();$("#mapview").append('<div id="measureResult"></div>');measureResult=new ol.Overlay({offset:[0,-15],positioning:'bottom-center',element:document.getElementById('measureResult')});map.addOverlay(measureResult);geom.on('change',function(e){console.log(e);var inPerDisplayUnit=INCHES_PER_UNIT['m'];var area=geom.getArea();if(inPerDisplayUnit){var inPerMapUnit=INCHES_PER_UNIT['dd'];area*=Math.pow((inPerMapUnit/inPerDisplayUnit),2);area=area*0.0015}if(area<1000){$("#measureResult").html(area.toFixed(2)+"亩")}else if(area<10000){$("#measureResult").html((area/1000).toFixed(2)+"千亩")}else if(area<100000){$("#measureResult").html((area/10E5).toFixed(2)+"万亩")}else if(area<1000000){$("#measureResult").html((area/10E6).toFixed(2)+"十万亩")}else{$("#measureResult").html((area/10E7).toFixed(2)+"百万亩")}measureResult.setPosition(geom.getInteriorPoint().getCoordinates())})},this);map_tools_pedit=new ol.control.Toggle({html:'<i class="fa fa-bookmark-o fa-rotate-270" ></i>',title:'测面',interaction:polygonDraw,bar:new ol.control.Bar({controls:[new ol.control.TextButton({html:'undo',title:"undo last point",handleClick:function(){fedit.getInteraction().removeLastPoint()}}),new ol.control.TextButton({html:'finish',title:"finish",handleClick:function(){var drawi=fedit.getInteraction();var lkey=drawi.on('drawend',function(e){drawi.unByKey(lkey);var c=e.feature.getGeometry().getCoordinates();if(c[0].length<4){throw "Bad Polygon"}});try{drawi.finishDrawing()}catch(e){drawi.unByKey(lkey)}}})]})});toolsMap['pedit']=map_tools_pedit;map_tools_mapo=new ol.control.Button({html:'<i class="fa fa-map-o"></i>',title:"图层叠加",handleClick:function(e){var status=$("#type_div",window.parent.document).find("span").attr("title");if(status=='隐藏'){$("#switch-panel",window.parent.document).animate({left:'-500px',opacity:'0'},500);$("#switch-panel",window.parent.document).css('display','none');$("#type_div",window.parent.document).find("span").attr("title","显示");$("#type_div",window.parent.document).find("span").removeClass("glyphicon-chevron-left");$("#type_div",window.parent.document).find("span").addClass("glyphicon-chevron-right")}else{$("#switch-panel",window.parent.document).css('display','block');$("#switch-panel",window.parent.document).animate({left:'22%',opacity:'1'},500);$("#type_div",window.parent.document).find("span").attr("title","隐藏");$("#type_div",window.parent.document).find("span").removeClass("glyphicon-chevron-right");$("#type_div",window.parent.document).find("span").addClass("glyphicon-chevron-left")}}});toolsMap['mapo']=map_tools_mapo;map_tools_pointsearch=new ol.control.Button({html:'<i class="fa fa-hand-o-down"></i>',title:"点查询",handleClick:function(){pointSearch()}});toolsMap['pointsearch']=map_tools_pointsearch;var charts=new ol.control.Button({html:'<i class="fa fa-search"></i>',title:"地图标点图",handleClick:function(){if(chartVector){map.removeLayer(chartVector)}var animation=false;var styleCache={};var chartType='pie3D';function getFeatureStyle(feature,sel){var k=chartType+"-Classic-"+(sel?"1-":"")+feature.get("data");var style=styleCache[k];if(!style){var radius=15;if(chartType!="bar"){radius=8*Math.sqrt(feature.get("size")/Math.PI)}var c="Classic";styleCache[k]=style=new ol.style.Style({image:new ol.style.Chart({type:chartType,radius:(sel?1.2:1)*radius,offsetY:chartType=='pie'?0:(sel?-1.2:-1)*feature.get("radius"),data:feature.get("data")||[10,30,20],colors:/,/.test(c)?c.split(","):c,rotateWithView:true,animation:animation,stroke:new ol.style.Stroke({color:"Classic"!="neon"?"#fff":"#000",width:2})})})}style.getImage().setAnimation(animation);return[style]}var ext=map.getView().calculateExtent(map.getSize());var features=[];for(var i=0;i<16;i+=1){var n,nb=0,data=[];for(var k=0;k<4;k+=1){n=Math.round(8*Math.random());data.push(n);nb+=n}features[i]=new ol.Feature({geometry:new ol.geom.Point([ext[0]+(ext[2]-ext[0])*Math.random(),ext[1]+(ext[3]-ext[1])*Math.random()]),data:data,size:nb})}chartVector=new ol.layer.Vector({name:"echart图层",source:new ol.source.Vector({features:features}),renderOrder:ol.ordering.yOrdering(),style:function(f){return getFeatureStyle(f,true)}});map.addLayer(chartVector);var select=new ol.interaction.Select({style:function(f){return getFeatureStyle(f,true)}});map.addInteraction(select);select.getFeatures().on(['add','remove'],function(e){if(e.type=="add"){console.log("Selection data: "+e.element.get("data").toString());}});var listenerKey;function doAnimate(){if(listenerKey){return}var start=new Date().getTime();var duration=1000;animation=0;listenerKey=vector.on('precompose',function(event){var frameState=event.frameState;var elapsed=frameState.time-start;if(elapsed>duration){ol.Observable.unByKey(listenerKey);listenerKey=null;animation=false}else{animation=ol.easing.easeOut(elapsed/duration);frameState.animate=true}chartVector.changed()});chartVector.changed();}doAnimate()}});map.addControl(new ol.control.MousePosition({undefinedHTML:'outside',projection:'EPSG:4326',coordinateFormat:function(coordinate){return ol.coordinate.format(coordinate,'{x}, {y}',5)}}));$(".ol-mouse-position").css('opacity','0');if(mapOption.tools){for(var key in mapOption["tools"]){if(mapOption["tools"][key]==true&&key!="mainbar"){editbar.addControl(toolsMap[key])}}}initToolbar(mapOption.toolbar)}function initToolbar(toolbar){if(toolbar==undefined){return}var editbar=new ol.control.Bar({toggleOne:true,group:false});if(mapOption.tools["mainbar"]==true){mainbar=new ol.control.Bar();map.addControl(mainbar);mainbar.addControl(editbar)}for(var i=0;i<toolbar.length;i+=1){var click=toolbar[i].click;toolsMap[toolbar[i].name]=new ol.control.Button({name:toolbar[i].name,html:'<i class="'+toolbar[i].icon+'"></i>',title:toolbar[i].title,clickEvent:toolbar[i].click,handleClick:function(e,options){if(options.clickEvent&&options.clickEvent!=''){eval(options.clickEvent)}}});editbar.addControl(toolsMap[toolbar[i].name])}}function loadPieChartLayer(layername,dataset,piedataset){if(dataset){var opt={};opt.name=layername;opt.url=cxt+"/datainterface/getdata/list/"+dataset;opt.piedataset=piedataset;addPieChartLayer(opt)}}function loadClusterLayer(layername,dataset,dataparams){if(dataset){var opt={};opt.name=layername;opt.url=cxt+"/datainterface/getdata/list/"+dataset;addClusterLayer(opt)}}function loadHeatmapLayer(layername,dataset,dataparams){if(dataset){var opt={};opt.name=layername;opt.url=cxt+"/datainterface/getdata/list/"+dataset;addHeatMapLayer(opt)}}function loadPoiLayer(layername,dataset,dataparams){if(dataset){var opt={};opt.name=layername;opt.url=cxt+"/datainterface/getdata/list/"+dataset;console.log(dataset);pointPoi(dataset,layername)}}function pointPoi(dataset,layername){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,success:function(data){if(data!=null&&data.data!=null){var _src=cxt+"/images/marker0.png";var coord=[];var iconStyle=new ol.style.Style({image:new ol.style.Icon(({anchor:[0.5,1],src:_src}))});iconStyle.getImage().setScale(0.7);var iconFeature=null;var features=[];for(var i=0;i<data.data.length;i+=1){coord=[data.data[i].X,data.data[i].Y];iconFeature=new ol.Feature({geometry:new ol.geom.Point(coord),name:'POI Test',type:'pois',population:4000,rainfall:500,params:data.data[i]});iconFeature.setStyle(iconStyle);features.push(iconFeature)}var vectorSource=new ol.source.Vector({features:features});var vectorLayer=new ol.layer.Vector({source:vectorSource});map.addLayer(vectorLayer);layers[layername]=vectorLayer;vectorLayer.setZIndex(40)}}})}function lineString(option){var dataset=option.dataset;var rows=option.params["rows"];for(var i=0;i<rows.length;i+=1){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,data:JSON.stringify(rows[i]),success:function(data){var lightWkt=[];var lightMap={};for(var i=0;i<data.data.length;i+=1){if(i==0){lightMap[data.data[i].NAME]=[];lightMap[data.data[i].NAME].push([data.data[i].X,data.data[i].Y])}else{if(data.data[i-1].NAME==data.data[i].NAME){lightMap[data.data[i-1].NAME].push([data.data[i].X,data.data[i].Y])}else{lightMap[data.data[i].NAME]=[];lightMap[data.data[i].NAME].push([data.data[i].X,data.data[i].Y])}}}for(var key in lightMap){var wkt="LINESTRING(";for(var j=0;j<lightMap[key].length;j+=1){wkt+=lightMap[key][j][0]+' '+lightMap[key][j][1]+','}wkt=wkt.substr(0,wkt.length-1);wkt+=')';lightWkt.push(wkt);linerMap[key]=wkt}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}linestringVector=new ol.layer.Vector({name:"轨迹图层",source:new ol.source.Vector({features:features}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:'#0bb7f9',width:3,})})});map.addLayer(linestringVector)}})}}function lightMapLayer(row){if(tableLightLayer){map.removeLayer(tableLightLayer)}var lightWkt=[linerMap[row.NAME]];var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}tableLightLayer=new ol.layer.Vector({name:"高亮图层",source:new ol.source.Vector({features:features}),style:new ol.style.Style({fill:new ol.style.Fill({color:'#333'}),stroke:new ol.style.Stroke({color:'#333',width:3,lineDash:[10,10]}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'#333'})})})});map.addLayer(tableLightLayer);map.getView().setCenter(ol.extent.getCenter(feature.getGeometry().getExtent()));map.getView().setZoom(22)}var poiVector;function addpoi(option){var dataset=option.dataset;if(option.clear==true){if(poiVector){map.removeLayer(poiVector)}}var theGlyph="";function setFont(g){if(typeof(g)=='string'){theGlyph=g}else{theGlyph=$(this).data("glyph")}vector.changed()}var glyph=ol.style.FontSymbol.prototype.defs.glyphs;function getFeatureStyle(feature){var st=[];if(mapOption.poishadow&&mapOption.poishadow==true){st.push(new ol.style.Style({image:new ol.style.Shadow({radius:15,blur:5,offsetX:0,offsetY:0,fill:new ol.style.Fill({color:"rgba(0,0,0,0.5)"})})}))}st.push(new ol.style.Style({image:new ol.style.FontSymbol({form:option.poiform?option.poiform:"none",gradient:option.poigradient?option.poigradient:"false",glyph:theGlyph,fontSize:Number(option.poifontsize?option.poifontsize:"1"),radius:Number(option.poiradius?option.poiradius:"15"),rotation:Number(option.poirotation?option.poirotation:"15")*Math.PI/180,rotateWithView:$("#rwview").prop('checked'),offsetY:$("#offset").prop('checked')? -Number($("#radius").val()):0,color:option.poicolor?option.poicolor:"",fill:new ol.style.Fill({color:option.poifillcolor?option.poifillcolor:"navy"}),stroke:new ol.style.Stroke({color:option.poistrokecolor?option.poistrokecolor:"white",width:Number(option.poiborder?option.poiborder:"3")})}),stroke:new ol.style.Stroke({width:2,color:'#f80'}),fill:new ol.style.Fill({color:[255,136,0,0.6]})}));return st}function getStyle(feature,resolution){var s=getFeatureStyle(feature);return s};var lightWkt=[];if(dataset&&dataset!=""){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,data:JSON.stringify(option.params),success:function(data){for(var i=0;i<data.data.length;i+=1){lightWkt.push('POINT('+data.data[i].X+' '+data.data[i].Y+')')}}})}else if(cbkPositionMap){lightWkt.push('POINT('+cbkPositionMap["x"]+' '+cbkPositionMap["y"]+')')}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}poiVector=new ol.layer.Vector({name:'1914-18',source:new ol.source.Vector({features:features}),renderOrder:ol.ordering.yOrdering(),style:getStyle});map.addLayer(poiVector);setFont(option.poifont?option.poifont:"fa-pied-piper-alt");vector.changed()}var popup=null;var popupVector=null;var popupSelect=null;function popupAnim(row){if(popupVector){map.removeLayer(popupVector)}if(popup){map.removeOverlay(popup)}if(popupSelect){map.removeInteraction(popupSelect)}popup=new ol.Overlay.Popup({popupClass:"black",closeBox:true,onclose:function(){map.removeInteraction(popupSelect);map.removeLayer(popupVector)},positioning:'bottom-center',autoPan:true,autoPanAnimation:{duration:100}});map.addOverlay(popup);var wkts=['POINT('+row.X+' '+row.Y+')'];var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<wkts.length;i+=1){var feature=wktformat.readFeature(wkts[i]);features.push(feature)}popupVector=new ol.layer.Vector({source:new ol.source.Vector({features:features}),style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(204, 204, 204, 1)'}),stroke:new ol.style.Stroke({color:'rgba(204, 204, 204, 1)',width:3}),image:new ol.style.Circle({radius:5,fill:new ol.style.Fill({color:'rgba(204, 204, 204, 1)'})})})});map.addLayer(popupVector);map.getView().setCenter(ol.extent.getCenter(features[0].getGeometry().getExtent()));popupSelect=new ol.interaction.Select({style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(204, 204, 204, 0)'}),stroke:new ol.style.Stroke({color:'rgba(204, 204, 204, 0)',width:0}),image:new ol.style.Circle({radius:7,fill:new ol.style.Fill({color:'rgba(204, 204, 204, 0)'})})})});map.addInteraction(popupSelect);var dataset=mapOption.popupoption["dataset"];var popParams=mapOption.popupoption["params"];var metadata=listOption["metadata"];var labelTextMap={};for(var i=0;i<metadata.length;i+=1){if(metadata[i].checkbox!=true){labelTextMap[metadata[i].field]=metadata[i].title}}console.log(labelTextMap);var content="<div class='ol-popup-content' style='padding: 10px;height:250px;overflow-y:auto;min-width:210px;'><p>";for(var key in labelTextMap){if(row[key]&&row[key]!="null"){content+='<label for="con">'+labelTextMap[key]+'：</label><span>'+row[key]+'</span><br/>'}else{content+='<label for="con">'+labelTextMap[key]+'：</label><span>未知</span><br/>'}}content+='</p></div>';popup.show([row.X,row.Y],content);$('.closeBox.hasclosebox').css('margin','5px 20px -11px -30px');$('.closeBox.hasclosebox').next().css('margin-right','0');popupSelect.getFeatures().on(['remove'],function(e){popup.hide()})}var cbkPositionMap={};var beforePositionVector,afterPositionVector;function callbackPosition(option){map.on('click',function(){var position=$('.ol-mouse-position').text().split(",");cbkPositionMap={"x":Number(position[0]),"y":Number(position[1])};if(option.clear==true){if(afterPositionVector){map.removeLayer(afterPositionVector)}}var dataset=option.dataset;var theGlyph="";function setFont(g){if(typeof(g)=='string'){theGlyph=g}else{theGlyph=$(this).data("glyph")}vector.changed()}var glyph=ol.style.FontSymbol.prototype.defs.glyphs;function getFeatureStyle(feature){var st=[];if(mapOption.poishadow&&mapOption.poishadow==true){st.push(new ol.style.Style({image:new ol.style.Shadow({radius:15,blur:5,offsetX:0,offsetY:0,fill:new ol.style.Fill({color:"rgba(0,0,0,0.5)"})})}))}st.push(new ol.style.Style({image:new ol.style.FontSymbol({form:option.poiform?option.poiform:"none",gradient:option.poigradient?option.poigradient:"false",glyph:theGlyph,fontSize:Number(option.poifontsize?option.poifontsize:"1"),radius:Number(option.poiradius?option.poiradius:"15"),rotation:Number(option.poirotation?option.poirotation:"15")*Math.PI/180,rotateWithView:$("#rwview").prop('checked'),offsetY:$("#offset").prop('checked')? -Number($("#radius").val()):0,color:option.poicolor?option.poicolor:"",fill:new ol.style.Fill({color:option.poifillcolor?option.poifillcolor:"navy"}),stroke:new ol.style.Stroke({color:option.poistrokecolor?option.poistrokecolor:"white",width:Number(option.poiborder?option.poiborder:"3")})}),stroke:new ol.style.Stroke({width:2,color:'#f80'}),fill:new ol.style.Fill({color:[255,136,0,0.6]})}));return st}function getStyle(feature,resolution){var s=getFeatureStyle(feature);return s};var lightWkt=[];if(dataset&&dataset!=""){$.ajax({type:"POST",dataType:"json",contentType:"application/json",url:cxt+"/datainterface/getdata/list/"+dataset,async:false,success:function(data){for(var i=0;i<data.data.length;i+=1){lightWkt.push('POINT('+data.data[i].X+' '+data.data[i].Y+')')}}})}else if(cbkPositionMap){lightWkt.push('POINT('+cbkPositionMap["x"]+' '+cbkPositionMap["y"]+')')}var wktformat=new ol.format.WKT();var features=[];for(var i=0;i<lightWkt.length;i+=1){var feature=wktformat.readFeature(lightWkt[i]);features.push(feature)}afterPositionVector=new ol.layer.Vector({name:'1914-18',source:new ol.source.Vector({features:features}),renderOrder:ol.ordering.yOrdering(),style:getStyle});map.addLayer(afterPositionVector);setFont(option.poifont?option.poifont:"fa-pied-piper-alt");vector.changed();switch(option.callback){case "queryXZQHByXY":queryXZQHByXY(cbkPositionMap["x"],cbkPositionMap["y"]);break;case "saveposition":saveposition(cbkPositionMap["x"],cbkPositionMap["y"]);break;default:break}})}function clearPoi(){var mappArr=[];mapArr=map.getLayers().a;for(var i=0;i<mapArr.length;i+=1){if(mapArr[i].T.name!='天地图'&&mapArr[i].T.name!='测绘图层'&&mapArr[i].T.name!='单选高亮图层'){map.removeLayer(mapArr[i])}}map.renderSync()}function maskFilter(wkt){if(wkt){var wktformat=new ol.format.WKT();var features=[];var centerArr=null;var feature=wktformat.readFeature(wkt);centerArr=new ol.extent.getCenter(feature.getGeometry().getExtent());features.push(feature);filterVector=new ol.layer.Vector({name:"Mask Fileter County Vector",source:new ol.source.Vector({features:features}),style:new ol.style.Style({fill:new ol.style.Fill({color:'rgba(204,204,204,0)'}),stroke:new ol.style.Stroke({color:'rgba(204,204,204,0)',width:0})})});map.addLayer(filterVector);var mask=new ol.filter.Mask({feature:feature,inner:false,fill:new ol.style.Fill({color:[255,255,255,1]})});filterVector.addFilter(mask);var extent=feature.getGeometry().getExtent();map.getView().fit(extent,map.getSize())}}